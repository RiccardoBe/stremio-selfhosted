services:
  mediaflow_proxy:
    image: qwertyuiop8899/easyproxy
    container_name: mediaflow_proxy
    env_file:
      - ./mfp/.env
    restart: unless-stopped
    networks:
      - proxy
    dns:
      - 1.1.1.1
      - 8.8.8.8
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mediaflow_proxy.rule=Host(`${MFP_SUBDOMAIN}.${DOMAIN}`)"
      - "traefik.http.routers.mediaflow_proxy.entrypoints=web"
      - "traefik.http.services.mediaflow_proxy.loadbalancer.server.port=7960"
      - "traefik.http.routers.mediaflow_proxy.middlewares=noindex@docker"

  streamvix:
    #build: https://github.com/qwertyuiop8899/streamvix.git#main
    image: qwertyuiop8899/streamvix:latest
    container_name: streamvix
    env_file:
      - ./streamvix/.env
    restart: unless-stopped 
    networks:
      - proxy
    dns:
      - 1.1.1.1
      - 8.8.8.8
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.streamvix.rule=Host(`${STREAMVIX_SUBDOMAIN}.${DOMAIN}`)"
      - "traefik.http.routers.streamvix.entrypoints=web"
      - "traefik.http.services.streamvix.loadbalancer.server.port=7860"
      - "traefik.http.routers.streamvix.middlewares=noindex@docker"

  aiostreams:
    # build: https://github.com/RiccardoBe/AIOStreams.git#main
    image: ghcr.io/viren070/aiostreams:latest
    container_name: aiostreams
    env_file:
      - ./aiostreams/.env
    volumes:
      - aiostreams-data:/app/data
    restart: unless-stopped 
    networks:
      - proxy
    dns:
      - 1.1.1.1
      - 8.8.8.8
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.aiostreams.rule=Host(`${AIOSTREAMS_SUBDOMAIN}.${DOMAIN}`)"
      - "traefik.http.routers.aiostreams.entrypoints=web"
      - "traefik.http.services.aiostreams.loadbalancer.server.port=3001"
      - "traefik.http.routers.aiostreams.middlewares=noindex@docker"

  aiometadata:
    image: ghcr.io/cedya77/aiometadata:latest
    container_name: aiometadata
    env_file:
      - ./aiometadata/.env
    restart: unless-stopped
    environment:
      - PORT=3232
      - HOST_NAME=${AIOMETADATA_SUBDOMAIN}.${DOMAIN}
      - REDIS_URL=redis://aiometadata_redis:6379
      - META_TTL=604800
      - CATALOG_TTL=86400
      - TMDB_TRENDING_TTL=10800
      - CATALOG_LIST_ITEMS_SIZE=20
      - LOG_LEVEL=debug
      - DATABASE_URI=sqlite://addon/data/db.sqlite
    labels:  # Optional: Remove if not using Traefik
      - "traefik.enable=true"
      - "traefik.http.services.aiometadata.loadbalancer.server.port=3232"
      - "traefik.http.routers.aiometadata.rule=Host(`${AIOMETADATA_SUBDOMAIN}.${DOMAIN}`)"
      - "traefik.http.routers.aiometadata.entrypoints=web"
      - "traefik.http.routers.aiometadata.middlewares=noindex@docker"
    volumes:
      - ./aiometadata/data:/app/addon/data
    depends_on:
      aiometadata_redis:
        condition: service_healthy
    tty: true
    networks:
      - proxy
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  aiometadata_redis:
    image: redis:latest
    container_name: aiometadata_redis
    restart: unless-stopped
    volumes:
      - ./aiometadata/cache:/data
    command: redis-server --appendonly yes --save 60 1
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - proxy
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_FILE=${LOG_FILE:-none}
      - LOG_HTML=${LOG_HTML:-false}
      - CAPTCHA_SOLVER=${CAPTCHA_SOLVER:-none}
      - TZ=Etc/UTC
    volumes:
      - ./flaresolverr:/config
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - proxy

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
    volumes:
      - ./prowlarr:/config
    ports:
      - 9696:9696
    restart: unless-stopped
    networks:
      - proxy
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  comet:
    container_name: comet
    image: g0ldyy/comet
    restart: unless-stopped
    ports:
      - "8000:8000"
      - "8765:8765"
    environment:
      DATABASE_TYPE: postgresql
      DATABASE_URL: comet:comet@postgres-comet:5432/comet
      COMETNET_ENABLED: "True"
      FASTAPI_WORKERS: "1"
    env_file:
      - ./comet/.env
    volumes:
      - ./comet/data:/app/data
    depends_on:
      postgres-comet:
        condition: service_healthy
    stop_grace_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - proxy
    labels:
      - "traefik.enable=true"

      # ===== comet.lusengir.com  -> 8000 =====
      - "traefik.http.routers.comet.rule=Host(`${COMET_SUBDOMAIN}.${DOMAIN}`)"
      - "traefik.http.routers.comet.entrypoints=web"
      - "traefik.http.routers.comet.middlewares=noindex@docker"
      - "traefik.http.routers.comet.service=comet-svc"
      - "traefik.http.services.comet-svc.loadbalancer.server.port=8000"

      # ===== cometnet.lusengir.com -> 8765 =====
      - "traefik.http.routers.cometnet.rule=Host(`${COMETNET_SUBDOMAIN}.${DOMAIN}`)"
      - "traefik.http.routers.cometnet.entrypoints=web"
      - "traefik.http.routers.cometnet.middlewares=noindex@docker"
      - "traefik.http.routers.cometnet.service=cometnet-svc"
      - "traefik.http.services.cometnet-svc.loadbalancer.server.port=8765"

  postgres-comet:
    container_name: comet-postgres
    image: postgres:18-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: comet
      POSTGRES_PASSWORD: comet
      POSTGRES_DB: comet
    volumes:
      - postgres_data:/var/lib/postgresql/
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U comet -d comet"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - proxy
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  aiostreams-data:
  comet_data:
  postgres_data:

networks:
  proxy:
    external: true